<!-- <p-toast position="top-right"></p-toast> -->
<p-confirmDialog
  header="åˆªé™¤ç¢ºèª"
  icon="pi pi-exclamation-triangle"
  acceptLabel="åˆªé™¤"
  rejectLabel="å–æ¶ˆ"
  acceptButtonStyleClass="p-button-danger"
></p-confirmDialog>

<div class="account-detail-page">
  <!-- Header -->
  <header class="account-detail-header">
    <div class="account-detail-header-text">
      <h1>Finance Accounts Detail</h1>
      <!-- <p class="account-detail-header-subtitle">ç®¡ç†ä½ çš„è³‡é‡‘å¸³æˆ¶ï¼ˆå°å¹£ã€å¤–å¹£ã€åˆ¸å•†â€¦ï¼‰ã€‚</p> -->
    </div>
  </header>

  @if (account()) {
  <p-card class="account-info-card">
    <div class="info-header">
      <div>
        <h2>{{ account()!.name }}</h2>
        <p>ç®¡ç†æ­¤å¸³æˆ¶çš„æŒæœ‰æ¨™çš„èˆ‡äº¤æ˜“ç´€éŒ„</p>
      </div>
      <div class="info-tags">
        <span class="tag type">{{ account()!.accountType }}</span>
        <span class="tag currency">{{ account()!.baseCurrency }}</span>
      </div>
    </div>

    <div class="info-body">
      <div class="info-item">
        <span class="label">åŸºç¤å¹£åˆ¥</span>
        <span class="value">{{ account()!.baseCurrency }}</span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="ç¸½è³‡ç”¢ï¼ç›®å‰æ‰€æœ‰æŒæœ‰æ¨™çš„çš„å¸‚å€¼ç¸½å’Œï¼ˆä¸ç­‰æ–¼æŠ•å…¥é‡‘é¡ï¼Œæœƒéš¨å¸‚å ´åƒ¹æ ¼è®Šå‹•ï¼‰"
          tooltipPosition="top"
        >
          ç¸½è³‡ç”¢
        </span>
        <span class="value">{{ accountTotalValue() | number : '1.0-0' }}</span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="æŠŠæ‰€æœ‰ç¾é‡‘æµå‡ºï¼ˆä¾‹å¦‚è²·é€²/å­˜å…¥ï¼Œè‚¡ç¥¨è²·é€²é‡‘é¡+è²·é€²æ‰‹çºŒè²»ï¼‰åŠ ç¸½ï¼Œç‚ºæŠ•è³‡äººè¦–è§’çš„ç´¯è¨ˆæŠ•å…¥"
          tooltipPosition="top"
          style="color: rgb(129, 71, 71)"
        >
          ç¸½æŠ•å…¥
        </span>
        <span class="value">{{ accountTotalInvested() | number : '1.0-0' }}</span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="æ·¨æŠ•å…¥ = ç¸½æŠ•å…¥ - æé ˜ï¼ˆWITHDRAWï¼‰ã€‚ä»£è¡¨ç›®å‰é‚„åœ¨å¸³æˆ¶æ± å­è£¡çš„æœ¬é‡‘"
          tooltipPosition="top"
        >
          æ·¨æŠ•å…¥
        </span>
        <span class="value">{{ accountNetInvested() | number : '1.0-0' }}</span>
      </div>

      <!-- âœ… å·²å¯¦ç¾ / æœªå¯¦ç¾ / ç¸½ç²åˆ©ï¼ˆç”¢å“ç´š Summaryï¼‰ -->
      <div class="info-item">
        <span class="label" pTooltip="{{ getUnrealizedTooltip() }}" tooltipPosition="top">
          æœªå¯¦ç¾æç›Š
        </span>

        <span
          class="value"
          [ngClass]="{
            positive: accountUnrealizedProfit() > 0,
            negative: accountUnrealizedProfit() < 0
          }"
        >
          {{ accountUnrealizedProfit() | number : '1.0-0' }}
        </span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="{{ getRealizedTooltip() }}"
          tooltipPosition="top"
          style="color: rgb(129, 71, 71)"
        >
          å·²å¯¦ç¾ç²åˆ©
        </span>

        <span
          class="value"
          [ngClass]="{
            positive: accountRealizedProfit() > 0,
            negative: accountRealizedProfit() < 0
          }"
        >
          {{ accountRealizedProfit() | number : '1.0-0' }}
          <small class="muted">({{ accountRealizedReturnRate() | number : '1.1-1' }}%)</small>
        </span>
      </div>

      <div class="info-item">
        <span class="label" pTooltip="{{ getTotalProfitTooltip() }}" tooltipPosition="top">
          ç¸½ç²åˆ©
        </span>

        <span
          class="value"
          [ngClass]="{
            positive: accountTotalProfit() > 0,
            negative: accountTotalProfit() < 0
          }"
        >
          {{ accountTotalProfit() | number : '1.0-0' }}
          <small class="muted">({{ accountTotalReturnRate() | number : '1.1-1' }}%)</small>
        </span>
      </div>
    </div>
  </p-card>
  } @else {
  <p-card class="account-info-card">
    <div class="p-skeleton p-skeleton-size">è¼‰å…¥å¸³æˆ¶è³‡è¨Š...</div>
  </p-card>
  }

  <p-card class="account-detail-card">
    <p-tabs [value]="activeTab()">
      <p-tablist>
        <p-tab value="holdings" (click)="activeTab.set('holdings')">æŒæœ‰æ¨™çš„</p-tab>
        <p-tab value="transactions" (click)="activeTab.set('transactions')">äº¤æ˜“ç´€éŒ„</p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Holdings Panel æŒæœ‰æ¨™çš„ -->
        <p-tabpanel value="holdings">
          <div class="panel-header">
            <div class="panel-title">
              <h3>æŒæœ‰æ¨™çš„</h3>
              <p>æŒæœ‰éƒ¨ä½ç”±äº¤æ˜“è‡ªå‹•é‡å»ºï¼ˆç”¢å“ç´šæ­£å¼ç‰ˆï¼‰</p>
            </div>

            <div class="panel-actions">
              <button
                pButton
                type="button"
                label="åˆ·æ–°å¸‚åƒ¹"
                icon="pi pi-refresh"
                class="p-button-outlined"
                [disabled]="isRefreshing()"
                (click)="refreshPrices(false)"
                pTooltip="åªåœ¨è³‡æ–™éèˆŠï¼ˆstaleï¼‰æ™‚æ›´æ–°"
                tooltipPosition="top"
              ></button>

              <button
                pButton
                type="button"
                label="å¼·åˆ¶åˆ·æ–°"
                icon="pi pi-bolt"
                class="p-button-warning"
                [loading]="isRefreshing()"
                [disabled]="!accountIdSignal()"
                (click)="confirmForceRefresh()"
                pTooltip="å¿½ç•¥ stale è¦å‰‡ï¼Œç›´æ¥é‡æŠ“å¸‚åƒ¹ï¼ˆå¯èƒ½è¼ƒè€—è³‡æºï¼‰"
                tooltipPosition="top"
              ></button>

              <button
                pButton
                type="button"
                label="æ–°å¢æŒæœ‰æ¨™çš„"
                icon="pi pi-plus"
                class="add-btn"
                (click)="openCreateHoldingDialog()"
              ></button>
            </div>
          </div>

          @if (holdings().length > 0) {
          <p-table
            #dt
            [value]="holdings()"
            dataKey="symbol"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="false"
            [paginator]="true"
            [globalFilterFields]="['symbol', 'name', 'assetType', 'currency']"
            class="holdings-table"
            [scrollable]="true"
            scrollHeight="flex"
          >
            <!-- â­â­â­ æ§åˆ¶æ¬„å¯¬ï¼šheader / filter / body å®Œå…¨åŒæ­¥ï¼ˆæœ€æ¨è–¦ç”¢å“ç´šåšæ³•ï¼‰ -->
            <ng-template pTemplate="colgroup">
              <colgroup>
                <col style="width: 110px" />
                <col style="width: 220px" />
                <col style="width: 96px" />
                <col style="width: 90px" />

                <col style="width: 110px" />
                <col style="width: 120px" />
                <col style="width: 120px" />
                <col style="width: 130px" />

                <col style="width: 170px" />

                <col style="width: 170px" />
                <!-- âœ… å·²å¯¦ç¾ç²åˆ© -->
                <col style="width: 160px" />
                <col style="width: 160px" />

                <col style="width: 170px" />
                <col style="width: 190px" />

                <col style="width: 128px" />
              </colgroup>
            </ng-template>

            <ng-template pTemplate="caption">
              <div class="table-caption">
                <div class="table-caption-left">
                  <!-- ä½ æœªä¾†æƒ³æ”¾çµ±è¨ˆ chips / æç¤ºæ–‡å­—å¯ä»¥æ”¾é€™è£¡ -->
                </div>

                <div class="table-caption-right">
                  <p-iconfield iconPosition="left">
                    <p-inputicon>
                      <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input
                      pInputText
                      type="text"
                      (input)="dt.filterGlobal($event.target.value, 'contains')"
                      placeholder="æœå°‹é—œéµå­—"
                    />
                  </p-iconfield>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th pFrozenColumn class="col-symbol">ä»£è™Ÿ</th>
                <th class="col-name">åç¨±</th>
                <th class="col-type">é¡å‹</th>
                <th class="col-currency">å¹£åˆ¥</th>

                <th class="text-right col-num">æ•¸é‡</th>
                <th
                  class="text-right col-price avg-cost"
                  pTooltip="æ­¤æ¨™çš„ç›®å‰æŒæœ‰éƒ¨ä½çš„ã€Œå¹³å‡æˆæœ¬ã€ï¼š
                            ï¼ ç´¯è¨ˆè²·é€²ç¸½æˆæœ¬ Ã· ç›®å‰æŒæœ‰æ•¸é‡

                            ğŸ“Œ èªªæ˜ï¼š
                            â€¢ è²·é€²ç¸½æˆæœ¬åŒ…å«è²·é€²é‡‘é¡ + æ‰‹çºŒè²» + äº¤æ˜“ç¨…
                            â€¢ æ¯æ¬¡è²·é€² / è³£å‡ºå¾Œï¼Œå‡åƒ¹éƒ½æœƒé‡æ–°è¨ˆç®—
                            â€¢ è‚¡åˆ© / åˆ©æ¯ä¸æœƒå½±éŸ¿å‡åƒ¹ï¼ˆå±¬æ–¼å·²å¯¦ç¾ç¾é‡‘æµï¼‰
                            â€¢ åªé‡å°ã€Œå°šæœªè³£å‡ºçš„éƒ¨ä½ã€è¨ˆç®—"
                  tooltipPosition="top"
                >
                  å‡åƒ¹
                </th>
                <th class="text-right col-price market-price">å¸‚åƒ¹</th>
                <th class="text-right col-money">å¸‚å€¼</th>

                <!-- âœ… ä½ è¦çš„ UI æ¨™ç¤ºï¼šæ¸…æ¥šæ‹†å‡ºè‚¡åˆ© -->
                <th
                  class="text-right col-money unrealized-pnl"
                  pTooltip="æ­¤æ¨™çš„ç›®å‰ã€Œå¸³é¢ä¸Šçš„åƒ¹å·®ã€ï¼š
                            ï¼ ç›®å‰å¸‚å€¼ï¼ˆå¸‚åƒ¹ Ã— æ•¸é‡ï¼‰
                            ï¼ æŒå€‰æˆæœ¬ï¼ˆå‡åƒ¹ Ã— æ•¸é‡ï¼‰

                            ğŸ“Œ èªªæ˜ï¼š
                            â€¢ åƒ…åæ˜ åƒ¹æ ¼æ¼²è·Œï¼Œå°šæœªè³£å‡º
                            â€¢ ä¸åŒ…å«è‚¡åˆ© / åˆ©æ¯ï¼ˆé‚£äº›å±¬æ–¼å·²å¯¦ç¾ç¾é‡‘æµï¼‰
                            â€¢ å°šæœªæ‰£é™¤è³£å‡ºæ™‚çš„æ‰‹çºŒè²»èˆ‡äº¤æ˜“ç¨…
                            â€¢ å¯¦éš›è³£å‡ºå¾Œï¼Œé‡‘é¡å¯èƒ½æœƒä¸åŒ"
                  tooltipPosition="top"
                >
                  æœªå¯¦ç¾æç›Šï¼ˆä¸å«è‚¡åˆ©ï¼‰
                </th>

                <th
                  class="text-right col-money realized-pnl"
                  pTooltip="å·²å¯¦ç¾ç²åˆ©ï¼å·²å¯¦ç¾å·®åƒ¹ï¼ˆSELL è½è¢‹ï¼‰ï¼‹å·²å¯¦ç¾æ”¶å…¥ï¼ˆè‚¡åˆ©/åˆ©æ¯ï¼‰ï¼Œä¸¦æ‰£é™¤æ‰‹çºŒè²»èˆ‡äº¤æ˜“ç¨…ã€‚"
                  tooltipPosition="top"
                >
                  å·²å¯¦ç¾ç²åˆ©
                </th>
                <th
                  class="text-right col-money total-pnl"
                  pTooltip=" ç¸½æç›Šï¼ˆå«è‚¡åˆ©ï¼‰ ï¼ 
                               æœªå¯¦ç¾æç›Š ï¼‹ å·²å¯¦ç¾äº¤æ˜“æç›Šï¼ˆè³£å‡ºå·®åƒ¹ï¼‰ï¼‹ å·²é ˜å–çš„è‚¡åˆ© / åˆ©æ¯

                            ğŸ“Œ èªªæ˜ï¼š
                            â€¢ æœªå¯¦ç¾æç›Šï¼šç›®å‰å¸‚åƒ¹ âˆ’ æŒå€‰æˆæœ¬(æœªåŒ…å«ã€Œå‡è¨­è³£å‡ºæ™‚ã€çš„æœªä¾†è²»ç”¨èˆ‡ç¨…é‡‘)
                            â€¢ å·²å¯¦ç¾é …ç›®ï¼ˆè³£å‡ºã€è‚¡åˆ©ã€åˆ©æ¯ï¼‰çš†å·²æ‰£é™¤æ‰‹çºŒè²»èˆ‡äº¤æ˜“ç¨…"
                  tooltipPosition="top"
                >
                  ç¸½æç›Šï¼ˆå«è‚¡åˆ©ï¼‰
                </th>
                <th
                  class="text-right col-money realized-dividend"
                  pTooltip="(å·²æ‰£æ‰æ‰‹çºŒè²»äºŒä»£å¥ä¿)"
                  tooltipPosition="top"
                  tooltipPosition="top"
                >
                  ç´¯ç©è‚¡åˆ©ï¼ˆå·²å¯¦ç¾ï¼‰
                </th>

                <!-- âœ… å ±é…¬ç‡ä¹Ÿæ‹†å…©å€‹ï¼šä¸å«è‚¡åˆ© vs å«è‚¡åˆ© -->
                <th class="text-right col-rate">å ±é…¬ç‡ï¼ˆä¸å«è‚¡åˆ©ï¼‰</th>
                <th class="text-right col-rate">ç¸½å ±é…¬ç‡ï¼ˆå«è‚¡åˆ©ï¼‰</th>

                <th class="actions-cell">æ“ä½œ</th>
              </tr>

              <!-- filter row -->
              <tr class="filter-row">
                <th pFrozenColumn>
                  <p-columnFilter
                    type="text"
                    field="symbol"
                    placeholder="ä»£è™Ÿ"
                    ariaLabel="Filter Symbol"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <th>
                  <p-columnFilter
                    type="text"
                    field="name"
                    placeholder="åç¨±"
                    ariaLabel="Filter Name"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <th>
                  <p-columnFilter
                    type="text"
                    field="assetType"
                    placeholder="é¡å‹"
                    ariaLabel="Filter Type"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <th>
                  <p-columnFilter
                    type="text"
                    field="currency"
                    placeholder="å¹£åˆ¥"
                    ariaLabel="Filter Currency"
                    filterOn="input"
                  ></p-columnFilter>
                </th>

                <th></th>
                <th></th>
                <th></th>
                <th></th>

                <th></th>
                <th></th>
                <th></th>
                <th></th>

                <th></th>
                <th></th>

                <th class="actions-cell"></th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-h>
              <tr>
                <td pFrozenColumn class="col-symbol">{{ h.symbol }}</td>
                <td class="col-name">
                  <div class="cell-title">{{ h.name }}</div>
                </td>
                <td class="col-type">
                  <span class="chip">{{ h.assetType }}</span>
                </td>
                <td class="col-currency">{{ h.currency }}</td>

                <td class="text-right col-num">{{ h.quantity | number : '1.0-4' }}</td>
                <td class="text-right col-price avg-cost">{{ h.avgCost | number : '1.0-4' }}</td>
                <td class="text-right col-price market-price">
                  {{ h.marketPrice | number : '1.0-4' }}
                </td>
                <td class="text-right col-money">{{ h.marketValue | number : '1.0-0' }}</td>

                <!-- âœ… æœªå¯¦ç¾æç›Šï¼ˆä¸å«è‚¡åˆ©ï¼‰ -->
                <td
                  class="text-right col-money unrealized-pnl"
                  [ngClass]="{ positive: h.unrealizedPnl > 0, negative: h.unrealizedPnl < 0 }"
                >
                  {{ h.unrealizedPnl | number : '1.0-0' }}
                </td>

                <!-- âœ… å·²å¯¦ç¾ç²åˆ© -->
                <td
                  class="text-right col-money realized-pnl"
                  [ngClass]="{ positive: h.realizedPnl > 0, negative: h.realizedPnl < 0 }"
                >
                  {{ h.realizedPnl | number : '1.0-0' }}
                </td>

                <!-- âœ… ç¸½æç›Šï¼ˆå«è‚¡åˆ©ï¼‰ -->
                <td
                  class="text-right col-money total-pnl"
                  [ngClass]="{ positive: h.totalPnl > 0, negative: h.totalPnl < 0 }"
                >
                  {{ h.totalPnl | number : '1.0-0' }}
                </td>

                <!-- âœ… ç´¯ç©è‚¡åˆ©ï¼ˆå·²å¯¦ç¾ï¼‰ -->
                <td
                  class="text-right col-money realized-dividend"
                  [ngClass]="{ positive: h.realizedDividend > 0, negative: h.realizedDividend < 0 }"
                >
                  {{ h.realizedDividend | number : '1.0-0' }}
                </td>

                <!-- âœ… å ±é…¬ç‡ï¼ˆä¸å«è‚¡åˆ©ï¼‰ -->
                <td
                  class="text-right col-rate"
                  [ngClass]="{ positive: h.returnRate > 0, negative: h.returnRate < 0 }"
                >
                  {{ h.returnRate | number : '1.1-1' }}%
                </td>

                <!-- âœ… ç¸½å ±é…¬ç‡ï¼ˆå«è‚¡åˆ©ï¼‰ -->
                <td
                  class="text-right col-rate"
                  [ngClass]="{ positive: h.totalReturnRate > 0, negative: h.totalReturnRate < 0 }"
                >
                  {{ h.totalReturnRate | number : '1.1-1' }}%
                </td>

                <td class="actions-cell">
                  <button
                    class="icon-btn row-icon-btn"
                    type="button"
                    pButton
                    icon="pi pi-dollar"
                    pTooltip="æ›´æ–°å¸‚åƒ¹"
                    (click)="openMarketPriceDialog(h)"
                  ></button>

                  <button
                    class="icon-btn row-icon-btn"
                    type="button"
                    pButton
                    icon="pi pi-pencil"
                    pTooltip="ç·¨è¼¯åŸºæœ¬è³‡æ–™"
                    (click)="openHoldingEdit(h)"
                  ></button>

                  <button
                    class="icon-btn row-icon-btn danger"
                    type="button"
                    pButton
                    icon="pi pi-trash"
                    pTooltip="åˆªé™¤ï¼ˆéœ€å…ˆåˆªäº¤æ˜“ï¼‰"
                    (click)="deleteHolding(h)"
                  ></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
          } @else {
          <div class="empty-block">ç›®å‰å°šæœªå»ºç«‹ä»»ä½•æŒæœ‰æ¨™çš„ã€‚</div>
          }
        </p-tabpanel>

        <!-- Transactions Paneläº¤æ˜“ç´€éŒ„ -->
        <p-tabpanel value="transactions">
          <div class="panel-header">
            <div class="panel-title">
              <h3>äº¤æ˜“ç´€éŒ„</h3>
              <p>æ­£å¼ç‰ˆï¼šäº¤æ˜“æ–°å¢/ç·¨è¼¯/åˆªé™¤éƒ½æœƒè‡ªå‹•é‡å»ºæŒæœ‰éƒ¨ä½</p>
            </div>
            <button
              pButton
              type="button"
              label="æ–°å¢äº¤æ˜“"
              icon="pi pi-plus"
              class="add-btn"
              (click)="openTransactionDialog()"
            ></button>
          </div>

          @if (transactions().length > 0) {
          <p-table
            #dtTx
            [value]="transactions()"
            dataKey="symbol"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="false"
            [paginator]="true"
            [globalFilterFields]="['tradeDate', 'type', 'symbol', 'currency']"
            class="transactions-table"
            [scrollable]="true"
            scrollHeight="flex"
          >
            <!-- â­â­â­ Transactions æ¬„å¯¬ä¹Ÿç”¨ colgroupï¼ˆä¸ç„¶ header/filter/body æœƒä¸åŒæ­¥ï¼‰ -->
            <ng-template pTemplate="colgroup">
              <colgroup>
                <!-- äº¤æ˜“ç´€éŒ„ æ—¥æœŸ -->
                <col style="width: 120px" />
                <!-- äº¤æ˜“ç´€éŒ„ é¡å‹ -->
                <col style="width: 140px" />
                <!-- äº¤æ˜“ç´€éŒ„ æ¨™çš„ -->
                <col style="width: 140px" />
                <!-- äº¤æ˜“ç´€éŒ„ å¹£åˆ¥ -->
                <col style="width: 90px" />
                <!-- äº¤æ˜“ç´€éŒ„ æ•¸é‡ -->
                <col style="width: 110px" />
                <!-- äº¤æ˜“ç´€éŒ„ åƒ¹æ ¼ -->
                <col style="width: 120px" />
                <!-- äº¤æ˜“ç´€éŒ„ æ‰‹çºŒè²» -->
                <col style="width: 110px" />
                <!-- äº¤æ˜“ç´€éŒ„ äº¤æ˜“ç¨… -->
                <col style="width: 110px" />
                <!-- äº¤æ˜“ç´€éŒ„ ç¾é‡‘æµ -->
                <col style="width: 140px" />
                <!-- äº¤æ˜“ç´€éŒ„ æ“ä½œ -->
                <col style="width: 128px" />
              </colgroup>
            </ng-template>

            <ng-template pTemplate="caption">
              <div class="table-caption">
                <div class="table-caption-left">
                  <!-- ä½ æœªä¾†æƒ³åŠ ï¼šå¿«é€Ÿç¯©é¸ï¼ˆBUY/SELL/Dividendï¼‰æŒ‰éˆ•ç¾¤ å¯ä»¥æ”¾é€™ -->
                </div>

                <div class="table-caption-right">
                  <p-iconfield iconPosition="left">
                    <p-inputicon>
                      <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input
                      pInputText
                      type="text"
                      (input)="dtTx.filterGlobal($event.target.value, 'contains')"
                      placeholder="æœå°‹é—œéµå­— (æ—¥æœŸ/é¡å‹/æ¨™çš„/å¹£åˆ¥)"
                      style="width: 20rem"
                    />
                  </p-iconfield>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <!-- äº¤æ˜“ç´€éŒ„ æ—¥æœŸ header -->
                <th pFrozenColumn class="col-date">æ—¥æœŸ</th>
                <!-- äº¤æ˜“ç´€éŒ„ é¡å‹ header -->
                <th pFrozenColumn class="col-txtype">é¡å‹</th>
                <!-- äº¤æ˜“ç´€éŒ„ æ¨™çš„ header -->
                <th class="col-symbol">æ¨™çš„</th>
                <!-- äº¤æ˜“ç´€éŒ„ å¹£åˆ¥ header -->
                <th class="col-currency">å¹£åˆ¥</th>
                <!-- äº¤æ˜“ç´€éŒ„ æ•¸é‡ header -->
                <th class="text-right col-num">æ•¸é‡</th>
                <!-- äº¤æ˜“ç´€éŒ„ åƒ¹æ ¼ header -->
                <th class="text-right col-price">åƒ¹æ ¼</th>
                <!-- äº¤æ˜“ç´€éŒ„ æ‰‹çºŒè²» header -->
                <th class="text-right col-money">æ‰‹çºŒè²»</th>
                <!-- äº¤æ˜“ç´€éŒ„ äº¤æ˜“ç¨… header -->
                <th class="text-right col-money">äº¤æ˜“ç¨…</th>
                <!-- äº¤æ˜“ç´€éŒ„ ç¾é‡‘æµ header -->
                <th class="text-right col-money">ç¾é‡‘æµ</th>
                <!-- äº¤æ˜“ç´€éŒ„ æ“ä½œ header -->
                <th class="actions-cell">æ“ä½œ</th>
              </tr>

              <tr class="filter-row">
                <!-- äº¤æ˜“ç´€éŒ„ æ—¥æœŸ Filter -->
                <th pFrozenColumn>
                  <p-columnFilter type="date" field="tradeDate" [showMenu]="false"></p-columnFilter>
                </th>
                <!-- äº¤æ˜“ç´€éŒ„ é¡å‹ Filter -->
                <th pFrozenColumn>
                  <p-columnFilter field="type" matchMode="equals" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="transactionTypeOptions"
                        optionLabel="label"
                        optionValue="value"
                        (onChange)="filter($event.value)"
                        placeholder="é¸æ“‡é¡å‹"
                        [showClear]="true"
                        style="width: 9rem"
                      >
                        <ng-template let-option pTemplate="item">
                          <p-tag [value]="option.label" [severity]="getSeverity(option.value)" />
                        </ng-template>
                      </p-select>
                    </ng-template>
                  </p-columnFilter>
                </th>
                <!-- äº¤æ˜“ç´€éŒ„ æ¨™çš„ Filter -->
                <th>
                  <p-columnFilter
                    type="text"
                    field="symbol"
                    placeholder="æ¨™çš„ä»£è™Ÿ"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <!-- äº¤æ˜“ç´€éŒ„ å¹£åˆ¥ Filter -->
                <th>
                  <p-columnFilter field="currency" matchMode="equals" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="currencyOptions"
                        optionLabel="label"
                        optionValue="value"
                        (onChange)="filter($event.value)"
                        placeholder="é¸æ“‡å¹£åˆ¥"
                        [showClear]="true"
                        style="width: 9rem"
                      ></p-select>
                    </ng-template>
                  </p-columnFilter>
                </th>
                <!-- äº¤æ˜“ç´€éŒ„ æ•¸é‡ Filter -->
                <th></th>
                <!-- äº¤æ˜“ç´€éŒ„ åƒ¹æ ¼ Filter -->
                <th></th>
                <!-- äº¤æ˜“ç´€éŒ„ æ‰‹çºŒè²» Filter -->
                <th></th>
                <!-- äº¤æ˜“ç´€éŒ„ äº¤æ˜“ç¨… Filter -->
                <th></th>
                <!-- äº¤æ˜“ç´€éŒ„ ç¾é‡‘æµ Filter -->
                <th></th>
                <!-- äº¤æ˜“ç´€éŒ„ æ“ä½œ Filter -->
                <th class="actions-cell"></th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-t>
              <tr>
                <!-- äº¤æ˜“ç´€éŒ„ æ—¥æœŸ table data -->
                <td pFrozenColumn class="col-date">{{ t.tradeDate | date : 'yyyy/MM/dd' }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ é¡å‹ table data -->
                <!-- <td>{{ t.type }}</td> -->
                <td pFrozenColumn class="col-txtype">
                  <p-tag
                    [value]="getFriendlyTypeLabel(t.type)"
                    [severity]="getSeverity(t.type)"
                    [pTooltip]="getTxTagTooltip(t.type)"
                    tooltipPosition="top"
                  />
                </td>

                <!-- äº¤æ˜“ç´€éŒ„ æ¨™çš„ table data -->
                <td class="col-symbol">{{ t.symbol }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ å¹£åˆ¥ table data -->
                <td class="col-currency">{{ t.currency }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ æ•¸é‡ table data -->
                <td class="text-right col-num">{{ t.quantity | number : '1.0-4' }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ åƒ¹æ ¼ table data -->
                <td class="text-right col-price">{{ t.price | number : '1.0-4' }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ æ‰‹çºŒè²» table data -->
                <td class="text-right col-money">{{ t.fee | number : '1.0-0' }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ äº¤æ˜“ç¨… table data -->
                <!-- äº¤æ˜“ç¨…ï¼šé SELL é€šå¸¸ç‚º 0 -->
                <td class="text-right col-money">{{ t.tax | number : '1.0-0' }}</td>

                <!-- äº¤æ˜“ç´€éŒ„ ç¾é‡‘æµ table data -->
                <td
                  class="text-right col-money"
                  [ngClass]="{ positive: t.totalAmount > 0, negative: t.totalAmount < 0 }"
                >
                  {{ t.totalAmount | number : '1.0-0' }}
                </td>

                <!-- äº¤æ˜“ç´€éŒ„ æ“ä½œ table data -->
                <td class="actions-cell">
                  <button
                    class="icon-btn row-icon-btn"
                    type="button"
                    pButton
                    icon="pi pi-pencil"
                    pTooltip="ç·¨è¼¯äº¤æ˜“"
                    (click)="openTransactionEdit(t)"
                  ></button>

                  <button
                    class="icon-btn row-icon-btn danger"
                    type="button"
                    pButton
                    icon="pi pi-trash"
                    pTooltip="åˆªé™¤äº¤æ˜“"
                    (click)="deleteTransaction(t)"
                  ></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
          } @else {
          <div class="empty-block">ç›®å‰å°šæœªæœ‰ä»»ä½•äº¤æ˜“ç´€éŒ„ã€‚</div>
          }
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </p-card>

  <!-- ARR -->
  @if (accountArrChartData()) {
  <p-card class="arr-card">
    <div class="arr-header">
      <h2>å¹´åŒ–å ±é…¬ç‡ï¼ˆARR / XIRRï¼‰</h2>
      <p>æ­£å¼ç‰ˆï¼šä½¿ç”¨æŠ•è³‡äººç¾é‡‘æµæ–¹å‘ï¼ˆTotalAmountï¼‰ + æœŸæœ«å¸‚å€¼ï¼ŒXIRR å¯é¡¯ç¤ºè² å€¼ã€‚</p>
    </div>

    <div class="mini-arr-chart">
      <p-chart
        type="bar"
        [data]="accountArrChartData()!"
        [options]="accountArrChartOptions"
      ></p-chart>
    </div>
  </p-card>
  }
</div>

<!-- ====================== Holdingï¼šæ–°å¢ Dialog ====================== -->
<p-dialog
  header="æ–°å¢æŒæœ‰æ¨™çš„"
  [(visible)]="displayCreateHoldingDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="createHoldingForm" class="form-grid">
    <div class="form-field">
      <label>æ¨™çš„ä»£è™Ÿ</label>
      <input pInputText formControlName="symbol" placeholder="ä¾‹å¦‚ï¼š0050ã€VTã€USD-CASH" />
    </div>

    <div class="form-field">
      <label>æ¨™çš„åç¨±</label>
      <input
        pInputText
        formControlName="name"
        placeholder="ä¾‹å¦‚ï¼šå…ƒå¤§å°ç£50ã€Vanguard VTã€USD Cash"
      />
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>é¡å‹</label>
        <p-select
          formControlName="assetType"
          [options]="assetTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>

      <div class="form-field">
        <label>å¹£åˆ¥</label>
        <p-select
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label>å¸‚åƒ¹ï¼ˆMarketPriceï¼‰</label>
      <input type="number" pInputText formControlName="marketPrice" min="0" />
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="å–æ¶ˆ"
      class="p-button-text"
      (click)="cancelCreateHolding()"
    ></button>
    <button
      pButton
      type="button"
      label="æ–°å¢"
      icon="pi pi-check"
      (click)="submitCreateHolding()"
      [disabled]="createHoldingForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Holdingï¼šç·¨è¼¯ Dialog ====================== -->
<p-dialog
  header="ç·¨è¼¯æŒæœ‰æ¨™çš„"
  [(visible)]="displayEditHoldingDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="editHoldingForm" class="form-grid">
    <div class="form-field">
      <label>æ¨™çš„ä»£è™Ÿ</label>
      <input pInputText formControlName="symbol" />
    </div>

    <div class="form-field">
      <label>æ¨™çš„åç¨±</label>
      <input pInputText formControlName="name" />
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>é¡å‹</label>
        <p-select
          formControlName="assetType"
          [options]="assetTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>

      <div class="form-field">
        <label>å¹£åˆ¥</label>
        <p-select
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="å–æ¶ˆ"
      class="p-button-text"
      (click)="cancelEditHolding()"
    ></button>
    <button
      pButton
      type="button"
      label="å„²å­˜"
      icon="pi pi-check"
      (click)="submitEditHolding()"
      [disabled]="editHoldingForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Holdingï¼šæ›´æ–°å¸‚åƒ¹ Dialog ====================== -->
<p-dialog
  header="æ›´æ–°å¸‚åƒ¹"
  [(visible)]="displayMarketPriceDialog"
  [modal]="true"
  [style]="{ width: '420px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ padding: '20px 24px 8px' }"
>
  <form [formGroup]="marketPriceForm" class="form-grid">
    <div class="form-field">
      <label>å¸‚åƒ¹ï¼ˆMarketPriceï¼‰</label>
      <input type="number" pInputText formControlName="marketPrice" min="0" />
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="å–æ¶ˆ"
      class="p-button-text"
      (click)="cancelMarketPrice()"
    ></button>
    <button
      pButton
      type="button"
      label="æ›´æ–°"
      icon="pi pi-check"
      (click)="submitMarketPrice()"
      [disabled]="marketPriceForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Transactionï¼šæ–°å¢ Dialog ====================== -->
<p-dialog
  header="æ–°å¢äº¤æ˜“"
  [(visible)]="displayTransactionDialog"
  [modal]="true"
  [style]="{ width: '560px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="createTransactionForm" class="form-grid">
    <div class="form-row">
      <div class="form-field">
        <label>æ—¥æœŸ</label>
        <input type="date" pInputText formControlName="tradeDate" />
      </div>

      <div class="form-field">
        <label>é¡å‹</label>
        <p-select
          formControlName="type"
          [options]="transactionTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
          (onChange)="onCreateTxTypeChange($event.value)"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label>é—œè¯æŒæœ‰æ¨™çš„ï¼ˆå¿…å¡«ï¼‰</label>
      <p-select
        formControlName="holdingId"
        [options]="holdings()"
        optionLabel="symbol"
        optionValue="id"
        placeholder="è«‹é¸æ“‡ holding"
        style="width: 100%"
        (onChange)="onTxHoldingChange($event.value)"
      ></p-select>
      @if (hasTxError('holdingId', 'required')) {
      <div class="error">holdingId å¿…å¡«</div>
      }
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>æ¨™çš„ä»£è™Ÿï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</label>
        <input pInputText formControlName="symbol" [readonly]="true" />
      </div>

      <div class="form-field">
        <label>å¹£åˆ¥ï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</label>
        <input pInputText formControlName="currency" [readonly]="true" />
      </div>
    </div>

    <!-- âœ… ä¾ type é¡¯ç¤ºæ¬„ä½ï¼šBUY/SELL é¡¯ç¤º quantity+priceï¼›å…¶ä»–é¡¯ç¤º amount -->
    @if (isBuySell(createTransactionForm.getRawValue().type)) {
    <div class="form-row">
      <div class="form-field">
        <label>æ•¸é‡</label>
        <input type="number" pInputText formControlName="quantity" min="0.0001" />
        @if (hasCreateTxError('quantity', 'required') || hasCreateTxError('quantity', 'min')) {
        <div class="error">æ•¸é‡ å¿…é ˆ > 0</div>
        }
      </div>

      <div class="form-field">
        <label>åƒ¹æ ¼</label>
        <input type="number" pInputText formControlName="price" min="0" />
        @if (hasCreateTxError('price', 'required') || hasCreateTxError('price', 'min')) {
        <div class="error">åƒ¹æ ¼ å¿…é ˆ >= 0</div>
        }
      </div>
    </div>
    } @else {
    <div class="form-field">
      <label>é‡‘é¡ï¼ˆamountï¼‰</label>
      <input type="number" pInputText formControlName="amount" min="0.01" />
      @if (hasCreateTxError('amount', 'required') || hasCreateTxError('amount', 'min')) {
      <div class="error">é‡‘é¡ å¿…å¡«ï¼Œä¸”å¿…é ˆ > 0</div>
      }
    </div>
    }

    <div class="form-row">
      <div class="form-field">
        <label
          pTooltip="æ‰‹çºŒè²»ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ï¼šfee = round(æˆäº¤é‡‘é¡ Ã— 0.1425% Ã— æŠ˜æ‰£)ã€‚å°è‚¡æœ€ä½æ‰‹çºŒè²»é€šå¸¸ 20 å…ƒï¼ˆæ­¤å·¥å…·åœ¨ TWD æœƒå¥—ç”¨ï¼‰ã€‚è‹¥ä½ æ‰‹å‹•ä¿®æ”¹ feeï¼Œç³»çµ±å°±ä¸å†è‡ªå‹•è¦†è“‹ã€‚"
          tooltipPosition="top"
        >
          æ‰‹çºŒè²»
        </label>
        <input type="number" pInputText formControlName="fee" min="0" />
      </div>

      <!-- âœ… âœ… åªæœ‰ SELL é¡¯ç¤ºäº¤æ˜“ç¨… -->
      @if (isSell(createTransactionForm.getRawValue().type)) {
      <div class="form-field">
        <label
          pTooltip="äº¤æ˜“ç¨…ï¼šè³£å‡ºé‡‘é¡ Ã—0.3%ï¼Œæœƒç´å…¥ã€ŒçœŸå¯¦å·²å¯¦ç¾ç²åˆ©ã€èˆ‡ç¾é‡‘æµè¨ˆç®—ï¼ˆSELL: æ‰£é™¤ï¼‰ã€‚"
          tooltipPosition="top"
        >
          äº¤æ˜“ç¨…
        </label>
        <input type="number" pInputText formControlName="tax" min="0" />
      </div>
      } @else {
      <!-- âœ… ä¸æ˜¯ SELL æ™‚ä¸é¡¯ç¤ºï¼›å€¼æœƒè¢« TS è‡ªå‹• reset ç‚º 0 -->
      }
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>å‚™è¨»</label>
        <input pInputText formControlName="note" />
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="å–æ¶ˆ"
      class="p-button-text"
      (click)="cancelTransactionDialog()"
    ></button>
    <button
      pButton
      type="button"
      label="æ–°å¢"
      icon="pi pi-check"
      (click)="submitTransaction()"
      [disabled]="createTransactionForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Transactionï¼šç·¨è¼¯ Dialog ====================== -->
<p-dialog
  header="ç·¨è¼¯äº¤æ˜“"
  [(visible)]="displayEditTransactionDialog"
  [modal]="true"
  [style]="{ width: '560px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="editTransactionForm" class="form-grid">
    <div class="form-row">
      <div class="form-field">
        <label>æ—¥æœŸ</label>
        <input type="date" pInputText formControlName="tradeDate" />
      </div>

      <div class="form-field">
        <label>é¡å‹</label>
        <p-select
          formControlName="type"
          [options]="transactionTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
          (onChange)="onEditTxTypeChange($event.value)"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label>é—œè¯æŒæœ‰æ¨™çš„ï¼ˆå¿…å¡«ï¼‰</label>
      <p-select
        formControlName="holdingId"
        [options]="holdings()"
        optionLabel="symbol"
        optionValue="id"
        style="width: 100%"
        (onChange)="onEditTxHoldingChange($event.value)"
      ></p-select>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>æ¨™çš„ä»£è™Ÿï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</label>
        <input pInputText formControlName="symbol" [readonly]="true" />
      </div>

      <div class="form-field">
        <label>å¹£åˆ¥ï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰</label>
        <input pInputText formControlName="currency" [readonly]="true" />
      </div>
    </div>

    <!-- âœ… ä¾ type é¡¯ç¤ºæ¬„ä½ï¼šBUY/SELL é¡¯ç¤º quantity+priceï¼›å…¶ä»–é¡¯ç¤º amount -->
    @if (isBuySell(editTransactionForm.getRawValue().type)) {
    <div class="form-row">
      <div class="form-field">
        <label>æ•¸é‡</label>
        <input type="number" pInputText formControlName="quantity" min="0.0001" />
        @if (hasEditTxError('quantity', 'required') || hasEditTxError('quantity', 'min')) {
        <div class="error">æ•¸é‡ å¿…é ˆ > 0</div>
        }
      </div>

      <div class="form-field">
        <label>åƒ¹æ ¼</label>
        <input type="number" pInputText formControlName="price" min="0" />
        @if (hasEditTxError('price', 'required') || hasEditTxError('price', 'min')) {
        <div class="error">åƒ¹æ ¼ å¿…é ˆ >= 0</div>
        }
      </div>
    </div>
    } @else {
    <div class="form-field">
      <label>é‡‘é¡ï¼ˆamountï¼‰</label>
      <input type="number" pInputText formControlName="amount" min="0.01" />
      @if (hasEditTxError('amount', 'required') || hasEditTxError('amount', 'min')) {
      <div class="error">é‡‘é¡ å¿…å¡«ï¼Œä¸”å¿…é ˆ > 0</div>
      }
    </div>
    }

    <div class="form-row">
      <div class="form-field">
        <label
          pTooltip="æ‰‹çºŒè²»ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ï¼šfee = round(æˆäº¤é‡‘é¡ Ã— 0.1425% Ã— æŠ˜æ‰£)ã€‚å°è‚¡æœ€ä½æ‰‹çºŒè²»é€šå¸¸ 20 å…ƒï¼ˆæ­¤å·¥å…·åœ¨ TWD æœƒå¥—ç”¨ï¼‰ã€‚è‹¥ä½ æ‰‹å‹•ä¿®æ”¹ feeï¼Œç³»çµ±å°±ä¸å†è‡ªå‹•è¦†è“‹ã€‚"
          tooltipPosition="top"
        >
          æ‰‹çºŒè²»
        </label>
        <input type="number" pInputText formControlName="fee" min="0" />
      </div>

      @if (isSell(editTransactionForm.getRawValue().type)) {
      <div class="form-field">
        <label
          pTooltip="äº¤æ˜“ç¨…ï¼ˆæ­£å¼ç‰ˆï¼‰ï¼šæœƒç´å…¥ã€ŒçœŸå¯¦å·²å¯¦ç¾ç²åˆ©ã€èˆ‡ç¾é‡‘æµè¨ˆç®—ï¼ˆSELL: æ‰£é™¤ï¼‰ã€‚"
          tooltipPosition="top"
        >
          äº¤æ˜“ç¨…
        </label>
        <input type="number" pInputText formControlName="tax" min="0" />
      </div>
      }
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>å‚™è¨»</label>
        <input pInputText formControlName="note" />
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="å–æ¶ˆ"
      class="p-button-text"
      (click)="cancelEditTransactionDialog()"
    ></button>
    <button
      pButton
      type="button"
      label="å„²å­˜"
      icon="pi pi-check"
      (click)="submitEditTransaction()"
      [disabled]="editTransactionForm.invalid"
    ></button>
  </ng-template>
</p-dialog>
