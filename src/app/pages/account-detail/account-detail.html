<!-- <p-toast position="top-right"></p-toast> -->
<p-confirmDialog
  header="刪除確認"
  icon="pi pi-exclamation-triangle"
  acceptLabel="刪除"
  rejectLabel="取消"
  acceptButtonStyleClass="p-button-danger"
></p-confirmDialog>

<div class="account-detail-page">
  <!-- Header -->
  <header class="account-detail-header">
    <div class="account-detail-header-text">
      <h1>Finance Accounts Detail</h1>
      <!-- <p class="account-detail-header-subtitle">管理你的資金帳戶（台幣、外幣、券商…）。</p> -->
    </div>
  </header>

  @if (account()) {
  <p-card class="account-info-card">
    <div class="info-header">
      <div>
        <h2>{{ account()!.name }}</h2>
        <p>管理此帳戶的持有標的與交易紀錄</p>
      </div>
      <div class="info-tags">
        <span class="tag type">{{ account()!.accountType }}</span>
        <span class="tag currency">{{ account()!.baseCurrency }}</span>
      </div>
    </div>

    <div class="info-body">
      <div class="info-item">
        <span class="label">基礎幣別</span>
        <span class="value">{{ account()!.baseCurrency }}</span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="總資產＝目前所有持有標的的市值總和（不等於投入金額，會隨市場價格變動）"
          tooltipPosition="top"
        >
          總資產
        </span>
        <span class="value">{{ accountTotalValue() | number : '1.0-0' }}</span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="把所有現金流出（例如買進/存入，股票買進金額+買進手續費）加總，為投資人視角的累計投入"
          tooltipPosition="top"
          style="color: rgb(129, 71, 71);"
        >
          總投入
        </span>
        <span class="value">{{ accountTotalInvested() | number : '1.0-0' }}</span>
      </div>

      <div class="info-item">
        <span
          class="label"
          pTooltip="淨投入 = 總投入 - 提領（WITHDRAW）。代表目前還在帳戶池子裡的本金"
          tooltipPosition="top"
        >
          淨投入
        </span>
        <span class="value">{{ accountNetInvested() | number : '1.0-0' }}</span>
      </div>

      <!-- ✅ 已實現 / 未實現 / 總獲利（產品級 Summary） -->
      <div class="info-item">
        <span class="label" pTooltip="{{ getUnrealizedTooltip() }}" tooltipPosition="top">
          未實現損益
        </span>

        <span
          class="value"
          [ngClass]="{
            positive: accountUnrealizedProfit() > 0,
            negative: accountUnrealizedProfit() < 0
          }"
        >
          {{ accountUnrealizedProfit() | number : '1.0-0' }}
        </span>
      </div>

      <div class="info-item">
        <span class="label" pTooltip="{{ getRealizedTooltip() }}" tooltipPosition="top" style="color: rgb(129, 71, 71);">
          已實現獲利
        </span>

        <span
          class="value"
          [ngClass]="{
            positive: accountRealizedProfit() > 0,
            negative: accountRealizedProfit() < 0
          }"
        >
          {{ accountRealizedProfit() | number : '1.0-0' }}
          <small class="muted">({{ accountRealizedReturnRate() | number : '1.1-1' }}%)</small>
        </span>
      </div>

      <div class="info-item">
        <span class="label" pTooltip="{{ getTotalProfitTooltip() }}" tooltipPosition="top">
          總獲利
        </span>

        <span
          class="value"
          [ngClass]="{
            positive: accountTotalProfit() > 0,
            negative: accountTotalProfit() < 0
          }"
        >
          {{ accountTotalProfit() | number : '1.0-0' }}
          <small class="muted">({{ accountTotalReturnRate() | number : '1.1-1' }}%)</small>
        </span>
      </div>
    </div>
  </p-card>
  } @else {
  <p-card class="account-info-card">
    <div class="p-skeleton p-skeleton-size">載入帳戶資訊...</div>
  </p-card>
  }

  <p-card class="account-detail-card">
    <p-tabs [value]="activeTab()">
      <p-tablist>
        <p-tab value="holdings" (click)="activeTab.set('holdings')">持有標的</p-tab>
        <p-tab value="transactions" (click)="activeTab.set('transactions')">交易紀錄</p-tab>
      </p-tablist>

      <p-tabpanels>
        <!-- Holdings Panel -->
        <p-tabpanel value="holdings">
          <div class="panel-header">
            <div class="panel-title">
              <h3>持有標的</h3>
              <p>持有部位由交易自動重建（產品級正式版）</p>
            </div>

            <button
              pButton
              type="button"
              label="新增持有標的"
              icon="pi pi-plus"
              class="add-btn"
              (click)="openCreateHoldingDialog()"
            ></button>
          </div>

          @if (holdings().length > 0) {
          <p-table
            #dt
            [value]="holdings()"
            dataKey="symbol"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="false"
            [paginator]="true"
            [globalFilterFields]="['symbol', 'name', 'assetType', 'currency']"
            class="holdings-table"
            [scrollable]="true"
            scrollHeight="flex"
          >
            <!-- ⭐⭐⭐ 控制欄寬：header / filter / body 完全同步（最推薦產品級做法） -->
            <ng-template pTemplate="colgroup">
              <colgroup>
                <col style="width: 110px" />
                <col style="width: 220px" />
                <col style="width: 96px" />
                <col style="width: 90px" />

                <col style="width: 110px" />
                <col style="width: 120px" />
                <col style="width: 120px" />
                <col style="width: 130px" />

                <col style="width: 170px" />
                <col style="width: 160px" />
                <col style="width: 160px" />

                <col style="width: 170px" />
                <col style="width: 190px" />

                <col style="width: 128px" />
              </colgroup>
            </ng-template>

            <ng-template pTemplate="caption">
              <div class="table-caption">
                <div class="table-caption-left">
                  <!-- 你未來想放統計 chips / 提示文字可以放這裡 -->
                </div>

                <div class="table-caption-right">
                  <p-iconfield iconPosition="left">
                    <p-inputicon>
                      <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input
                      pInputText
                      type="text"
                      (input)="dt.filterGlobal($event.target.value, 'contains')"
                      placeholder="搜尋關鍵字"
                    />
                  </p-iconfield>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th pFrozenColumn class="col-symbol">代號</th>
                <th class="col-name">名稱</th>
                <th class="col-type">類型</th>
                <th class="col-currency">幣別</th>

                <th class="text-right col-num">數量</th>
                <th class="text-right col-price avg-cost">均價</th>
                <th class="text-right col-price market-price">市價</th>
                <th class="text-right col-money">市值</th>

                <!-- ✅ 你要的 UI 標示：清楚拆出股利 -->
                <th class="text-right col-money unrealized-pnl">未實現損益（不含股利）</th>
                <th class="text-right col-money realized-dividend">累積股利（已實現）</th>
                <th class="text-right col-money total-pnl">總損益（含股利）</th>

                <!-- ✅ 報酬率也拆兩個：不含股利 vs 含股利 -->
                <th class="text-right col-rate">報酬率（不含股利）</th>
                <th class="text-right col-rate">總報酬率（含股利）</th>

                <th class="actions-cell">操作</th>
              </tr>

              <!-- filter row -->
              <tr class="filter-row">
                <th pFrozenColumn>
                  <p-columnFilter
                    type="text"
                    field="symbol"
                    placeholder="代號"
                    ariaLabel="Filter Symbol"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <th>
                  <p-columnFilter
                    type="text"
                    field="name"
                    placeholder="名稱"
                    ariaLabel="Filter Name"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <th>
                  <p-columnFilter
                    type="text"
                    field="assetType"
                    placeholder="類型"
                    ariaLabel="Filter Type"
                    filterOn="input"
                  ></p-columnFilter>
                </th>
                <th>
                  <p-columnFilter
                    type="text"
                    field="currency"
                    placeholder="幣別"
                    ariaLabel="Filter Currency"
                    filterOn="input"
                  ></p-columnFilter>
                </th>

                <th></th>
                <th></th>
                <th></th>
                <th></th>

                <th></th>
                <th></th>
                <th></th>

                <th></th>
                <th></th>

                <th class="actions-cell"></th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-h>
              <tr>
                <td pFrozenColumn class="col-symbol">{{ h.symbol }}</td>
                <td class="col-name">
                  <div class="cell-title">{{ h.name }}</div>
                </td>
                <td class="col-type">
                  <span class="chip">{{ h.assetType }}</span>
                </td>
                <td class="col-currency">{{ h.currency }}</td>

                <td class="text-right col-num">{{ h.quantity | number : '1.0-4' }}</td>
                <td class="text-right col-price avg-cost">{{ h.avgCost | number : '1.0-4' }}</td>
                <td class="text-right col-price market-price">
                  {{ h.marketPrice | number : '1.0-4' }}
                </td>
                <td class="text-right col-money">{{ h.marketValue | number : '1.0-0' }}</td>

                <!-- ✅ 未實現損益（不含股利） -->
                <td
                  class="text-right col-money unrealized-pnl"
                  [ngClass]="{ positive: h.unrealizedPnl > 0, negative: h.unrealizedPnl < 0 }"
                >
                  {{ h.unrealizedPnl | number : '1.0-0' }}
                </td>

                <!-- ✅ 累積股利（已實現） -->
                <td
                  class="text-right col-money realized-dividend"
                  [ngClass]="{ positive: h.realizedDividend > 0, negative: h.realizedDividend < 0 }"
                >
                  {{ h.realizedDividend | number : '1.0-0' }}
                </td>

                <!-- ✅ 總損益（含股利） -->
                <td
                  class="text-right col-money total-pnl"
                  [ngClass]="{ positive: h.totalPnl > 0, negative: h.totalPnl < 0 }"
                >
                  {{ h.totalPnl | number : '1.0-0' }}
                </td>

                <!-- ✅ 報酬率（不含股利） -->
                <td
                  class="text-right col-rate"
                  [ngClass]="{ positive: h.returnRate > 0, negative: h.returnRate < 0 }"
                >
                  {{ h.returnRate | number : '1.1-1' }}%
                </td>

                <!-- ✅ 總報酬率（含股利） -->
                <td
                  class="text-right col-rate"
                  [ngClass]="{ positive: h.totalReturnRate > 0, negative: h.totalReturnRate < 0 }"
                >
                  {{ h.totalReturnRate | number : '1.1-1' }}%
                </td>

                <td class="actions-cell">
                  <button
                    class="icon-btn row-icon-btn"
                    type="button"
                    pButton
                    icon="pi pi-dollar"
                    pTooltip="更新市價"
                    (click)="openMarketPriceDialog(h)"
                  ></button>

                  <button
                    class="icon-btn row-icon-btn"
                    type="button"
                    pButton
                    icon="pi pi-pencil"
                    pTooltip="編輯基本資料"
                    (click)="openHoldingEdit(h)"
                  ></button>

                  <button
                    class="icon-btn row-icon-btn danger"
                    type="button"
                    pButton
                    icon="pi pi-trash"
                    pTooltip="刪除（需先刪交易）"
                    (click)="deleteHolding(h)"
                  ></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
          } @else {
          <div class="empty-block">目前尚未建立任何持有標的。</div>
          }
        </p-tabpanel>

        <!-- Transactions Panel -->
        <!-- Transactions Panel -->
        <p-tabpanel value="transactions">
          <div class="panel-header">
            <div class="panel-title">
              <h3>交易紀錄</h3>
              <p>正式版：交易新增/編輯/刪除都會自動重建持有部位</p>
            </div>
            <button
              pButton
              type="button"
              label="新增交易"
              icon="pi pi-plus"
              class="add-btn"
              (click)="openTransactionDialog()"
            ></button>
          </div>

          @if (transactions().length > 0) {
          <p-table
            #dtTx
            [value]="transactions()"
            dataKey="symbol"
            [rows]="10"
            [rowsPerPageOptions]="[10, 25, 50]"
            [loading]="false"
            [paginator]="true"
            [globalFilterFields]="['tradeDate', 'type', 'symbol', 'currency']"
            class="transactions-table"
            [scrollable]="true"
            scrollHeight="flex"
          >
            <!-- ⭐⭐⭐ Transactions 欄寬也用 colgroup（不然 header/filter/body 會不同步） -->
            <ng-template pTemplate="colgroup">
              <colgroup>
                <col style="width: 120px" />
                <!-- 日期 -->
                <col style="width: 140px" />
                <!-- 類型 -->
                <col style="width: 140px" />
                <!-- 標的 -->
                <col style="width: 90px" />
                <!-- 幣別 -->
                <col style="width: 110px" />
                <!-- 數量 -->
                <col style="width: 120px" />
                <!-- 價格 -->
                <col style="width: 110px" />
                <!-- 手續費 -->
                <col style="width: 110px" />
                <!-- ✅ 交易稅 -->
                <col style="width: 140px" />
                <!-- 現金流 -->
                <col style="width: 128px" />
                <!-- 操作 -->
              </colgroup>
            </ng-template>

            <ng-template pTemplate="caption">
              <div class="table-caption">
                <div class="table-caption-left">
                  <!-- 你未來想加：快速篩選（BUY/SELL/Dividend）按鈕群 可以放這 -->
                </div>

                <div class="table-caption-right">
                  <p-iconfield iconPosition="left">
                    <p-inputicon>
                      <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input
                      pInputText
                      type="text"
                      (input)="dtTx.filterGlobal($event.target.value, 'contains')"
                      placeholder="搜尋關鍵字 (日期/類型/標的/幣別)"
                      style="width: 20rem"
                    />
                  </p-iconfield>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th pFrozenColumn class="col-date">日期</th>
                <th pFrozenColumn class="col-txtype">類型</th>
                <th class="col-symbol">標的</th>
                <th class="col-currency">幣別</th>
                <th class="text-right col-num">數量</th>
                <th class="text-right col-price">價格</th>
                <th class="text-right col-money">手續費</th>
                <th class="text-right col-money">交易稅</th>
                <th class="text-right col-money">現金流</th>
                <th class="actions-cell">操作</th>
              </tr>

              <tr class="filter-row">
                <th pFrozenColumn>
                  <p-columnFilter type="date" field="tradeDate" [showMenu]="false"></p-columnFilter>
                </th>

                <th pFrozenColumn>
                  <p-columnFilter field="type" matchMode="equals" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="transactionTypeOptions"
                        (onChange)="filter($event.value)"
                        placeholder="選擇類型"
                        [showClear]="true"
                        style="width: 9rem"
                      >
                        <ng-template let-option pTemplate="item">
                          <p-tag [value]="option.label" [severity]="getSeverity(option.value)" />
                        </ng-template>
                      </p-select>
                    </ng-template>
                  </p-columnFilter>
                </th>

                <th>
                  <p-columnFilter
                    type="text"
                    field="symbol"
                    placeholder="標的代號"
                    filterOn="input"
                  ></p-columnFilter>
                </th>

                <th>
                  <p-columnFilter field="currency" matchMode="equals" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="currencyOptions"
                        (onChange)="filter($event.value)"
                        placeholder="選擇幣別"
                        [showClear]="true"
                        style="width: 9rem"
                      ></p-select>
                    </ng-template>
                  </p-columnFilter>
                </th>

                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th class="actions-cell"></th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-t>
              <tr>
                <td pFrozenColumn class="col-date">{{ t.tradeDate | date : 'yyyy/MM/dd' }}</td>

                <!-- <td>{{ t.type }}</td> -->
                <td pFrozenColumn class="col-txtype">
                  <p-tag
                    [value]="getFriendlyTypeLabel(t.type)"
                    [severity]="getSeverity(t.type)"
                    [pTooltip]="getTxTagTooltip(t.type)"
                    tooltipPosition="top"
                  />
                </td>

                <td class="col-symbol">{{ t.symbol }}</td>
                <td class="col-currency">{{ t.currency }}</td>

                <td class="text-right col-num">{{ t.quantity | number : '1.0-4' }}</td>
                <td class="text-right col-price">{{ t.price | number : '1.0-4' }}</td>
                <td class="text-right col-money">{{ t.fee | number : '1.0-0' }}</td>

                <!-- ✅ 交易稅：非 SELL 通常為 0 -->
                <td class="text-right col-money">{{ t.tax | number : '1.0-0' }}</td>

                <td
                  class="text-right col-money"
                  [ngClass]="{ positive: t.totalAmount > 0, negative: t.totalAmount < 0 }"
                >
                  {{ t.totalAmount | number : '1.0-0' }}
                </td>

                <td class="actions-cell">
                  <button
                    class="icon-btn row-icon-btn"
                    type="button"
                    pButton
                    icon="pi pi-pencil"
                    pTooltip="編輯交易"
                    (click)="openTransactionEdit(t)"
                  ></button>

                  <button
                    class="icon-btn row-icon-btn danger"
                    type="button"
                    pButton
                    icon="pi pi-trash"
                    pTooltip="刪除交易"
                    (click)="deleteTransaction(t)"
                  ></button>
                </td>
              </tr>
            </ng-template>
          </p-table>
          } @else {
          <div class="empty-block">目前尚未有任何交易紀錄。</div>
          }
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </p-card>

  <!-- ARR -->
  @if (accountArrChartData()) {
  <p-card class="arr-card">
    <div class="arr-header">
      <h2>年化報酬率（ARR / XIRR）</h2>
      <p>正式版：使用投資人現金流方向（TotalAmount） + 期末市值，XIRR 可顯示負值。</p>
    </div>

    <div class="mini-arr-chart">
      <p-chart
        type="bar"
        [data]="accountArrChartData()!"
        [options]="accountArrChartOptions"
      ></p-chart>
    </div>
  </p-card>
  }
</div>

<!-- ====================== Holding：新增 Dialog ====================== -->
<p-dialog
  header="新增持有標的"
  [(visible)]="displayCreateHoldingDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="createHoldingForm" class="form-grid">
    <div class="form-field">
      <label>標的代號</label>
      <input pInputText formControlName="symbol" placeholder="例如：0050、VT、USD-CASH" />
    </div>

    <div class="form-field">
      <label>標的名稱</label>
      <input
        pInputText
        formControlName="name"
        placeholder="例如：元大台灣50、Vanguard VT、USD Cash"
      />
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>類型</label>
        <p-select
          formControlName="assetType"
          [options]="assetTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>

      <div class="form-field">
        <label>幣別</label>
        <p-select
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label>市價（MarketPrice）</label>
      <input type="number" pInputText formControlName="marketPrice" min="0" />
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelCreateHolding()"
    ></button>
    <button
      pButton
      type="button"
      label="新增"
      icon="pi pi-check"
      (click)="submitCreateHolding()"
      [disabled]="createHoldingForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Holding：編輯 Dialog ====================== -->
<p-dialog
  header="編輯持有標的"
  [(visible)]="displayEditHoldingDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="editHoldingForm" class="form-grid">
    <div class="form-field">
      <label>標的代號</label>
      <input pInputText formControlName="symbol" />
    </div>

    <div class="form-field">
      <label>標的名稱</label>
      <input pInputText formControlName="name" />
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>類型</label>
        <p-select
          formControlName="assetType"
          [options]="assetTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>

      <div class="form-field">
        <label>幣別</label>
        <p-select
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelEditHolding()"
    ></button>
    <button
      pButton
      type="button"
      label="儲存"
      icon="pi pi-check"
      (click)="submitEditHolding()"
      [disabled]="editHoldingForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Holding：更新市價 Dialog ====================== -->
<p-dialog
  header="更新市價"
  [(visible)]="displayMarketPriceDialog"
  [modal]="true"
  [style]="{ width: '420px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ padding: '20px 24px 8px' }"
>
  <form [formGroup]="marketPriceForm" class="form-grid">
    <div class="form-field">
      <label>市價（MarketPrice）</label>
      <input type="number" pInputText formControlName="marketPrice" min="0" />
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelMarketPrice()"
    ></button>
    <button
      pButton
      type="button"
      label="更新"
      icon="pi pi-check"
      (click)="submitMarketPrice()"
      [disabled]="marketPriceForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Transaction：新增 Dialog ====================== -->
<p-dialog
  header="新增交易"
  [(visible)]="displayTransactionDialog"
  [modal]="true"
  [style]="{ width: '560px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="createTransactionForm" class="form-grid">
    <div class="form-row">
      <div class="form-field">
        <label>日期</label>
        <input type="date" pInputText formControlName="tradeDate" />
      </div>

      <div class="form-field">
        <label>類型</label>
        <p-select
          formControlName="type"
          [options]="transactionTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
          (onChange)="onCreateTxTypeChange($event.value)"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label>關聯持有標的（必填）</label>
      <p-select
        formControlName="holdingId"
        [options]="holdings()"
        optionLabel="symbol"
        optionValue="id"
        placeholder="請選擇 holding"
        style="width: 100%"
        (onChange)="onTxHoldingChange($event.value)"
      ></p-select>
      @if (hasTxError('holdingId', 'required')) {
      <div class="error">holdingId 必填</div>
      }
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>標的代號（自動帶入）</label>
        <input pInputText formControlName="symbol" [readonly]="true" />
      </div>

      <div class="form-field">
        <label>幣別（自動帶入）</label>
        <input pInputText formControlName="currency" [readonly]="true" />
      </div>
    </div>

    <!-- ✅ 依 type 顯示欄位：BUY/SELL 顯示 quantity+price；其他顯示 amount -->
    @if (isBuySell(createTransactionForm.getRawValue().type)) {
    <div class="form-row">
      <div class="form-field">
        <label>數量</label>
        <input type="number" pInputText formControlName="quantity" min="0.0001" />
        @if (hasCreateTxError('quantity', 'required') || hasCreateTxError('quantity', 'min')) {
        <div class="error">quantity 必須 > 0</div>
        }
      </div>

      <div class="form-field">
        <label>價格</label>
        <input type="number" pInputText formControlName="price" min="0" />
        @if (hasCreateTxError('price', 'required') || hasCreateTxError('price', 'min')) {
        <div class="error">price 必須 >= 0</div>
        }
      </div>
    </div>
    } @else {
    <div class="form-field">
      <label>金額（amount）</label>
      <input type="number" pInputText formControlName="amount" min="0.01" />
      @if (hasCreateTxError('amount', 'required') || hasCreateTxError('amount', 'min')) {
      <div class="error">amount 必填，且必須 > 0</div>
      }
    </div>
    }

    <div class="form-row">
      <div class="form-field">
        <label
          pTooltip="手續費（自動計算）：fee = round(成交金額 × 0.1425% × 折扣)。台股最低手續費通常 20 元（此工具在 TWD 會套用）。若你手動修改 fee，系統就不再自動覆蓋。"
          tooltipPosition="top"
        >
          手續費
        </label>
        <input type="number" pInputText formControlName="fee" min="0" />
      </div>

      <!-- ✅ ✅ 只有 SELL 顯示交易稅 -->
      @if (isSell(createTransactionForm.getRawValue().type)) {
      <div class="form-field">
        <label
          pTooltip="交易稅（正式版）：會納入「真實已實現獲利」與現金流計算（SELL: 扣除）。"
          tooltipPosition="top"
        >
          交易稅
        </label>
        <input type="number" pInputText formControlName="tax" min="0" />
      </div>
      } @else {
      <!-- ✅ 不是 SELL 時不顯示；值會被 TS 自動 reset 為 0 -->
      }
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>備註</label>
        <input pInputText formControlName="note" />
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelTransactionDialog()"
    ></button>
    <button
      pButton
      type="button"
      label="新增"
      icon="pi pi-check"
      (click)="submitTransaction()"
      [disabled]="createTransactionForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- ====================== Transaction：編輯 Dialog ====================== -->
<p-dialog
  header="編輯交易"
  [(visible)]="displayEditTransactionDialog"
  [modal]="true"
  [style]="{ width: '560px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="editTransactionForm" class="form-grid">
    <div class="form-row">
      <div class="form-field">
        <label>日期</label>
        <input type="date" pInputText formControlName="tradeDate" />
      </div>

      <div class="form-field">
        <label>類型</label>
        <p-select
          formControlName="type"
          [options]="transactionTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
          (onChange)="onEditTxTypeChange($event.value)"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label>關聯持有標的（必填）</label>
      <p-select
        formControlName="holdingId"
        [options]="holdings()"
        optionLabel="symbol"
        optionValue="id"
        style="width: 100%"
        (onChange)="onEditTxHoldingChange($event.value)"
      ></p-select>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>標的代號（自動帶入）</label>
        <input pInputText formControlName="symbol" [readonly]="true" />
      </div>

      <div class="form-field">
        <label>幣別（自動帶入）</label>
        <input pInputText formControlName="currency" [readonly]="true" />
      </div>
    </div>

    <!-- ✅ 依 type 顯示欄位：BUY/SELL 顯示 quantity+price；其他顯示 amount -->
    @if (isBuySell(editTransactionForm.getRawValue().type)) {
    <div class="form-row">
      <div class="form-field">
        <label>數量</label>
        <input type="number" pInputText formControlName="quantity" min="0.0001" />
        @if (hasEditTxError('quantity', 'required') || hasEditTxError('quantity', 'min')) {
        <div class="error">quantity 必須 > 0</div>
        }
      </div>

      <div class="form-field">
        <label>價格</label>
        <input type="number" pInputText formControlName="price" min="0" />
        @if (hasEditTxError('price', 'required') || hasEditTxError('price', 'min')) {
        <div class="error">price 必須 >= 0</div>
        }
      </div>
    </div>
    } @else {
    <div class="form-field">
      <label>金額（amount）</label>
      <input type="number" pInputText formControlName="amount" min="0.01" />
      @if (hasEditTxError('amount', 'required') || hasEditTxError('amount', 'min')) {
      <div class="error">amount 必填，且必須 > 0</div>
      }
    </div>
    }

    <div class="form-row">
      <div class="form-field">
        <label
          pTooltip="手續費（自動計算）：fee = round(成交金額 × 0.1425% × 折扣)。台股最低手續費通常 20 元（此工具在 TWD 會套用）。若你手動修改 fee，系統就不再自動覆蓋。"
          tooltipPosition="top"
        >
          手續費
        </label>
        <input type="number" pInputText formControlName="fee" min="0" />
      </div>

      @if (isSell(editTransactionForm.getRawValue().type)) {
      <div class="form-field">
        <label
          pTooltip="交易稅（正式版）：會納入「真實已實現獲利」與現金流計算（SELL: 扣除）。"
          tooltipPosition="top"
        >
          交易稅
        </label>
        <input type="number" pInputText formControlName="tax" min="0" />
      </div>
      }
    </div>

    <div class="form-row">
      <div class="form-field">
        <label>備註</label>
        <input pInputText formControlName="note" />
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelEditTransactionDialog()"
    ></button>
    <button
      pButton
      type="button"
      label="儲存"
      icon="pi pi-check"
      (click)="submitEditTransaction()"
      [disabled]="editTransactionForm.invalid"
    ></button>
  </ng-template>
</p-dialog>
