<p-toast position="top-right"></p-toast>

<!-- 上半部：Account Info Card -->
<p-card class="account-info-card" *ngIf="account() as acc">
  <div class="info-header">
    <div>
      <h2>{{ acc.name }}</h2>
      <p>管理此帳戶的持有標的與交易紀錄</p>
    </div>
    <div class="info-tags">
      <span class="tag type">{{ acc.accountType }}</span>
      <span class="tag currency">{{ acc.baseCurrency }}</span>
    </div>
  </div>

  <div class="info-body">
    <div class="info-item">
      <span class="label">基礎幣別</span>
      <span class="value">{{ acc.baseCurrency }}</span>
    </div>
    <div class="info-item">
      <span class="label">總資產</span>
      <span class="value">
        {{ accountTotalValue() | number : '1.0-0' }}
      </span>
    </div>
  </div>
</p-card>

<!-- Tabs：Holdings / Transactions -->
<p-card class="account-detail-card">
  <p-tabs [value]="activeTab()">
    <p-tablist>
      <p-tab value="holdings" (click)="activeTab.set('holdings')"> 持有標的 </p-tab>
      <p-tab value="transactions" (click)="activeTab.set('transactions')"> 交易紀錄 </p-tab>
    </p-tablist>

    <p-tabpanels>
      <!-- Holdings Panel -->
      <p-tabpanel value="holdings">
        <div class="panel-header">
          <div class="panel-title">
            <h3>持有標的</h3>
            <p>瀏覽目前此帳戶底下的 ETF / 股票 / 現金等持有部位</p>
          </div>
          <button
            pButton
            type="button"
            label="新增持有標的"
            icon="pi pi-plus"
            class="add-btn"
            (click)="openCreateHoldingDialog()"
          ></button>
        </div>

        <p-table
          [value]="holdings()"
          class="holdings-table"
          *ngIf="holdings().length > 0; else noHoldings"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>代號</th>
              <th>名稱</th>
              <th>類型</th>
              <th class="text-right">數量</th>
              <th class="text-right">平均成本</th>
              <th class="text-right">市值</th>
              <th class="text-right">未實現損益</th>
              <th class="text-right">報酬率</th>
              <th class="actions-cell">操作</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-h>
            <tr>
              <td>{{ h.symbol }}</td>
              <td>{{ h.name }}</td>
              <td>{{ h.assetType }}</td>
              <td class="text-right">
                {{ h.quantity | number : '1.0-2' }}
              </td>
              <td class="text-right">
                {{ h.avgCost | number : '1.0-2' }}
              </td>
              <td class="text-right">
                {{ h.marketValue | number : '1.0-0' }}
              </td>
              <td
                class="text-right"
                [ngClass]="{
                  positive: h.unrealizedPnl > 0,
                  negative: h.unrealizedPnl < 0
                }"
              >
                {{ h.unrealizedPnl | number : '1.0-0' }}
              </td>
              <td
                class="text-right"
                [ngClass]="{
                  positive: h.returnRate > 0,
                  negative: h.returnRate < 0
                }"
              >
                {{ h.returnRate | number : '1.1-1' }}%
              </td>
              <td class="actions-cell">
                <button
                  class="icon-btn row-icon-btn"
                  type="button"
                  pButton
                  icon="pi pi-eye"
                  pTooltip="查看明細"
                  (click)="openHoldingView(h)"
                ></button>

                <button
                  class="icon-btn row-icon-btn"
                  type="button"
                  pButton
                  icon="pi pi-pencil"
                  pTooltip="調整數量 / 成本"
                  (click)="openHoldingEdit(h)"
                ></button>

                <button
                  class="icon-btn row-icon-btn danger"
                  type="button"
                  pButton
                  icon="pi pi-trash"
                  pTooltip="刪除"
                  (click)="deleteHolding(h)"
                ></button>
              </td>
            </tr>
          </ng-template>
        </p-table>

        <ng-template #noHoldings>
          <div class="empty-block">目前尚未建立任何持有標的，點右上角「新增持有標的」開始吧！</div>
        </ng-template>
      </p-tabpanel>

      <!-- Transactions Panel -->
      <p-tabpanel value="transactions">
        <div class="panel-header">
          <div class="panel-title">
            <h3>交易紀錄</h3>
            <p>顯示此帳戶的買進、賣出、存入、提領與股利紀錄</p>
          </div>
          <button
            pButton
            type="button"
            label="新增交易"
            icon="pi pi-plus"
            class="add-btn"
            (click)="openTransactionDialog()"
          ></button>
        </div>

        <p-table
          [value]="transactions()"
          class="transactions-table"
          *ngIf="transactions().length > 0; else noTx"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>日期</th>
              <th>類型</th>
              <th>標的</th>
              <th class="text-right">數量</th>
              <th class="text-right">價格</th>
              <th class="text-right">手續費</th>
              <th class="text-right">金額</th>
              <th>幣別</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-t>
            <tr>
              <td>{{ t.tradeDate | date : 'yyyy/MM/dd' }}</td>
              <td>{{ t.type }}</td>
              <td>{{ t.symbol }}</td>
              <td class="text-right">
                {{ t.quantity | number : '1.0-2' }}
              </td>
              <td class="text-right">
                {{ t.price | number : '1.0-2' }}
              </td>
              <td class="text-right">
                {{ t.fee | number : '1.0-0' }}
              </td>
              <td class="text-right">
                {{ t.totalAmount | number : '1.0-0' }}
              </td>
              <td>{{ t.currency }}</td>
            </tr>
          </ng-template>
        </p-table>

        <ng-template #noTx>
          <div class="empty-block">目前尚未有任何交易紀錄。</div>
        </ng-template>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</p-card>

<!-- ARR -->
@if (accountArrChartData()) {
<p-card class="arr-card">
  <div class="arr-header">
    <h2>年化報酬率（ARR / XIRR）</h2>
    <p>
      依照此帳戶每檔標的的買進、賣出、股利與利息等現金流， 以 XIRR 方式估算實際年化報酬率。 //
      如果只顯示前五名標的:（顯示前五名標的）
    </p>
  </div>

  <div class="mini-arr-chart" *ngIf="accountArrChartData() as chart">
    <p-chart type="bar" [data]="chart" [options]="accountArrChartOptions"></p-chart>
  </div>
</p-card>
}

<!-- 新增 Holding Dialog（原本那個） -->

<p-dialog
  header="新增持有標的"
  [(visible)]="displayCreateHoldingDialog"
  [modal]="true"
  [style]="{ width: '480px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="createHoldingForm" class="form-grid">
    <div class="form-field">
      <label for="symbol">標的代號</label>
      <input
        id="symbol"
        type="text"
        pInputText
        formControlName="symbol"
        placeholder="例如：0050、VT、USD-CASH"
      />
      <div class="error" *ngIf="hasCreateHoldingError('symbol', 'required')">標的代號為必填</div>
    </div>

    <div class="form-field">
      <label for="name">標的名稱</label>
      <input
        id="name"
        type="text"
        pInputText
        formControlName="name"
        placeholder="例如：元大台灣 50、Vanguard Total World"
      />
      <div class="error" *ngIf="hasCreateHoldingError('name', 'required')">標的名稱為必填</div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="assetType">類型</label>
        <p-select
          id="assetType"
          formControlName="assetType"
          [options]="assetTypeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="選擇類型"
          style="width: 100%"
        ></p-select>
      </div>

      <div class="form-field">
        <label for="currency">幣別</label>
        <p-select
          id="currency"
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="選擇幣別"
          style="width: 100%"
        ></p-select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="quantity">持有數量</label>
        <input id="quantity" type="number" pInputText formControlName="quantity" min="0" />
      </div>

      <div class="form-field">
        <label for="avgCost">平均成本</label>
        <input id="avgCost" type="number" pInputText formControlName="avgCost" min="0" />
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelCreateHolding()"
    ></button>

    <button
      pButton
      type="button"
      label="新增持有標的"
      icon="pi pi-check"
      (click)="submitCreateHolding()"
      [disabled]="createHoldingForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- 查看 / 編輯 Holding Dialog -->
<p-dialog
  [header]="isViewHoldingMode() ? '持有標的明細' : '編輯持有標的'"
  [(visible)]="displayEditHoldingDialog"
  [modal]="true"
  [style]="{ width: '480px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="editHoldingForm" class="form-grid">
    <div class="form-field">
      <label for="edit-symbol">標的代號</label>
      <input id="edit-symbol" type="text" pInputText formControlName="symbol" />
      <div class="error" *ngIf="hasEditHoldingError('symbol', 'required')">標的代號為必填</div>
    </div>

    <div class="form-field">
      <label for="edit-name">標的名稱</label>
      <input id="edit-name" type="text" pInputText formControlName="name" />
      <div class="error" *ngIf="hasEditHoldingError('name', 'required')">標的名稱為必填</div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="edit-assetType">類型</label>
        <p-select
          id="edit-assetType"
          formControlName="assetType"
          [options]="assetTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>

      <div class="form-field">
        <label for="edit-currency">幣別</label>
        <p-select
          id="edit-currency"
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="edit-quantity">持有數量</label>
        <input id="edit-quantity" type="number" pInputText formControlName="quantity" />
      </div>

      <div class="form-field">
        <label for="edit-avgCost">平均成本</label>
        <input id="edit-avgCost" type="number" pInputText formControlName="avgCost" />
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="關閉"
      class="p-button-text"
      (click)="cancelEditHolding()"
    ></button>

    <button
      *ngIf="!isViewHoldingMode()"
      pButton
      type="button"
      label="儲存變更"
      icon="pi pi-check"
      (click)="submitEditHolding()"
      [disabled]="editHoldingForm.invalid"
    ></button>
  </ng-template>
</p-dialog>

<!-- 新增交易 Dialog -->
<p-dialog
  header="新增交易"
  [(visible)]="displayTransactionDialog"
  [modal]="true"
  [style]="{ width: '520px' }"
  [draggable]="false"
  [resizable]="false"
  [contentStyle]="{ 'overflow-y': 'visible', padding: '20px 24px 8px' }"
>
  <form [formGroup]="createTransactionForm" class="form-grid">
    <div class="form-row">
      <div class="form-field">
        <label for="tx-date">日期</label>
        <input id="tx-date" type="date" pInputText formControlName="tradeDate" />
      </div>

      <div class="form-field">
        <label for="tx-type">類型</label>
        <p-select
          id="tx-type"
          formControlName="type"
          [options]="transactionTypeOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>

    <div class="form-field">
      <label for="tx-holding">關聯持有標的（可選）</label>
      <p-select
        id="tx-holding"
        formControlName="holdingId"
        [options]="holdings()"
        optionLabel="symbol"
        optionValue="id"
        placeholder="選擇要關聯的持有標的"
        style="width: 100%"
        (onChange)="onTxHoldingChange($event.value)"
      ></p-select>
    </div>

    <div class="form-field">
      <label for="tx-symbol">標的代號</label>
      <input
        id="tx-symbol"
        type="text"
        pInputText
        formControlName="symbol"
        placeholder="例如：0050、VT、存入可填對應帳戶名"
      />
      <div class="error" *ngIf="hasTxError('symbol', 'required')">標的為必填</div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="tx-quantity">數量</label>
        <input id="tx-quantity" type="number" pInputText formControlName="quantity" min="0" />
      </div>

      <div class="form-field">
        <label for="tx-price">價格</label>
        <input id="tx-price" type="number" pInputText formControlName="price" min="0" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-field">
        <label for="tx-fee">手續費</label>
        <input id="tx-fee" type="number" pInputText formControlName="fee" min="0" />
      </div>

      <div class="form-field">
        <label for="tx-currency">幣別</label>
        <p-select
          id="tx-currency"
          formControlName="currency"
          [options]="currencyOptions"
          optionLabel="label"
          optionValue="value"
          style="width: 100%"
        ></p-select>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="取消"
      class="p-button-text"
      (click)="cancelTransactionDialog()"
    ></button>

    <button
      pButton
      type="button"
      label="新增交易"
      icon="pi pi-check"
      (click)="submitTransaction()"
      [disabled]="createTransactionForm.invalid"
    ></button>
  </ng-template>
</p-dialog>
